
    <html>
      <head><title>Test coverage for vnccollab.theme.browser.wizardjson</title>
      <style type="text/css">
        a {text-decoration: none; display: block; padding-right: 1em;}
        a:hover {background: #EFA;}
        hr {height: 1px; border: none; border-top: 1px solid gray;}
        .notcovered {background: #FCC;}
        .footer {margin: 2em; font-size: small; color: gray;}
      </style>
      </head>
      <body><h1>Test coverage for vnccollab.theme.browser.wizardjson</h1>
      <table>
    
<tr><td><a href="vnccollab.html">vnccollab/</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 58% (1732 of 4159 uncovered)</td></tr>
<tr><td><a href="vnccollab.theme.html">&nbsp;&nbsp;&nbsp;&nbsp;theme/</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 58% (1732 of 4159 uncovered)</td></tr>
<tr><td><a href="vnccollab.theme.browser.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;browser/</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 52% (979 of 2059 uncovered)</td></tr>
<tr><td><a href="vnccollab.theme.browser.wizardjson.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wizardjson.py</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 20% (95 of 119 uncovered)</td></tr>
</table><hr/>
<pre>    1: import simplejson
       
    1: from Acquisition import aq_parent
    1: from AccessControl import getSecurityManager
       
    1: from Products.Five.browser import BrowserView
    1: from Products.CMFPlone.utils import safe_unicode
    1: from Products.CMFCore import permissions
    1: from Products.CMFCore.utils import getToolByName
    1: from Products.CMFCore.interfaces import ISiteRoot, IFolderish
       
    1: from plone import api
    1: from plone.uuid.interfaces import IUUID
    1: from plone.app.contentlisting.interfaces import IContentListing
       
       
    2: class GetTreeJson(BrowserView):
           '''Returns a JSON representation of the directory structure
    1:        to be used by jquery.dynatree library.'''
       
    1:     def getInitialTree(self):
               '''Returns the initial tree for the dynatree.'''
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         context = self.getFolderishParent(self.context)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         child_tree = None</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         child_uid = None</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         while True:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             is_root = ISiteRoot.providedBy(context)</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             if is_root:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 uid = None</div>                   else:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 uid = IUUID(context)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             tree = self.get_tree(uid)</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             if child_tree is not None:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 self._insert_child_tree(tree, child_tree, child_uid)</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             if is_root:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 break</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             context = aq_parent(context)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             child_tree = tree</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             child_uid = uid</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         root_node = self.getRootNode()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         root_node['children'] = tree</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return simplejson.dumps(root_node)</div>       
    1:     def getRootNode(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         portal = api.portal.get()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         tree = self._info_from_content(portal)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return tree</div>       
    1:     def getFolderishParent(self, obj):
               '''Returns obj or its nearest parent that is folderish.'''
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         while True:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             if IFolderish.providedBy(obj):</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 return obj</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             obj = aq_parent(obj)</div>       
    1:     def _insert_child_tree(self, tree, child_tree, child_uid):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         for branch in tree:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             if branch.get('key', False) == child_uid:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 branch['children'] = child_tree</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 branch['isLazy'] = False</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 branch['expand'] = True</div>       
    1:     def getTree(self, uid=None, type_=None):
               '''Returns the (lazy) tree for a given node.
       
                  params:
                      uid: UUID of the container to get its tree.
               '''
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         results = self.get_tree(uid=uid)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return simplejson.dumps(results)</div>       
    1:     def get_tree(self, uid=None, type_=None):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if type_ is None:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             type_ = self.request.get('type_', None)</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         catalog = getToolByName(self.context, 'portal_catalog')</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         container_path = ''</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if uid is not None:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             container = catalog(UID=uid)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             if len(container) == 1:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 container = container[0]</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 container_path = container.getPath()</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if not container_path:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             portal = api.portal.get()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             container_path = '/'.join(portal.getPhysicalPath())</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         query = {'portal_type': self._get_container_types(),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                  'path': {'query': container_path, 'depth': 1}}</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         results = IContentListing(catalog(**query))</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         results = [self._info_from_content(x, type_) for x in results]</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         results.sort(lambda x, y: cmp(x['title'], y['title']))</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return results</div>       
    1:     def _info_from_content(self, content, type_=None):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         content_is_root = ISiteRoot.providedBy(content)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if content_is_root:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             content_uid = '0'</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             obj = content</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             path = content.absolute_url_path()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             url = content.absolute_url()</div>               else:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             obj = content.getObject()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             path = content.getPath()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             url = content.getURL()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             content_uid = content.uuid()</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         selectable = self._is_container_selectable(obj, type_)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         context = self.getFolderishParent(self.context)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         context_is_root = ISiteRoot.providedBy(context)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if context_is_root:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             context_uid = '0'</div>               else:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             context_uid = IUUID(context)</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         i_am_context = context_uid == content_uid</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         result = {</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'key': content_uid,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'id': content.getId(),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'title': safe_unicode(content.Title()).encode('utf-8'),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'tooltip': safe_unicode(content.Description()).encode('utf-8'),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'icon': content.getIcon(),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'noLink': True,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'isFolder': True,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'isLazy': True,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'path': path,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'url': url,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'unselectable': not(selectable),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'activate': selectable and i_am_context,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'children': [],</div>               }
       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return result</div>       
    1:     def _get_container_types(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return ['Folder']</div>       
    1:     def _is_container_selectable(self, container, type_):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         writable = self._is_container_writable(container)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if not writable:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return False</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return self._is_type_allowed_in_container(container, type_)</div>       
    1:     def _is_type_allowed_in_container(self, obj, type_):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if type_ is None:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return True</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         allowed_types = list(obj.getLocallyAllowedTypes())</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return type_ in allowed_types</div>       
    1:     def _is_container_writable(self, obj):
               '''True if the current user can write in the object container.
       
               NOTE: We need to access to the associate object, and this could
               be time consuming. In case of degradation of speed, check here.
               '''
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         perm = getSecurityManager().checkPermission(</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             permissions.AddPortalContent, obj)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return perm == 1</div></pre>

      <div class="footer">
      Generated for revision wyeksportowane on 2013-11-05 18:00:40.809438Z
      </div>
    </body>
    </html>
