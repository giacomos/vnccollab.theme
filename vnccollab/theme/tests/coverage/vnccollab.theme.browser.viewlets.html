
    <html>
      <head><title>Test coverage for vnccollab.theme.browser.viewlets</title>
      <style type="text/css">
        a {text-decoration: none; display: block; padding-right: 1em;}
        a:hover {background: #EFA;}
        hr {height: 1px; border: none; border-top: 1px solid gray;}
        .notcovered {background: #FCC;}
        .footer {margin: 2em; font-size: small; color: gray;}
      </style>
      </head>
      <body><h1>Test coverage for vnccollab.theme.browser.viewlets</h1>
      <table>
    
<tr><td><a href="vnccollab.html">vnccollab/</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 63% (1501 of 4163 uncovered)</td></tr>
<tr><td><a href="vnccollab.theme.html">&nbsp;&nbsp;&nbsp;&nbsp;theme/</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 63% (1501 of 4163 uncovered)</td></tr>
<tr><td><a href="vnccollab.theme.browser.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;browser/</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 63% (745 of 2059 uncovered)</td></tr>
<tr><td><a href="vnccollab.theme.browser.viewlets.html">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;viewlets.py</a></td> <td style="background: red">&nbsp;&nbsp;&nbsp;&nbsp;</td> <td>covered 71% (133 of 472 uncovered)</td></tr>
</table><hr/>
<pre>    1: from urllib import quote_plus
    1: import logging
    1: import os.path
    1: from pyactiveresource.activeresource import ActiveResource
       
    1: from Acquisition import aq_inner
    1: from DateTime import DateTime
       
    1: from zope.app.component.hooks import getSite
    1: from zope.interface import alsoProvides, providedBy, Interface
    1: from zope.component import getMultiAdapter, queryMultiAdapter, getUtility
    1: from zope.i18nmessageid import MessageFactory
    1: from zope.viewlet.interfaces import IViewlet
       
    1: from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile
    1: from Products.CMFCore.utils import getToolByName
    1: from Products.CMFCore.interfaces import IActionCategory, IAction
    1: from Products.CMFCore.ActionInformation import ActionInfo
    1: from Products.CMFPlone.utils import safe_unicode, normalizeString, parent
    1: from Products.CMFPlone.i18nl10n import monthname_msgid, weekdayname_msgid
    1: from Products.CMFPlone.interfaces.siteroot import IPloneSiteRoot
       
    1: from plone.i18n.normalizer.interfaces import IIDNormalizer
    1: from plone.app.contentmenu.menu import FactoriesSubMenuItem
    1: from plone.app.viewletmanager.manager import BaseOrderedViewletManager
    1: from plone.app.layout.viewlets import common
    1: from plone.app.layout.viewlets.interfaces import IPortalHeader
    1: from plone.memoize.instance import memoize
    1: from plone.registry.interfaces import IRegistry
    1: from plone.portlets.interfaces import IPortletManager, IPortletRenderer
       
    1: from Products.Carousel.browser.viewlet import CarouselViewlet
       # from jarn.xmpp.core.browser.viewlet import XMPPViewlet
       
    1: from collective.quickupload.portlet.quickuploadportlet import JAVASCRIPT
       
    1: from vnccollab.theme.portlets.zimbra_mail import logException
    1: from vnccollab.theme import messageFactory as _
    1: from vnccollab.theme.avatar import IAvatarUtil
    1: from vnccollab.theme.config import FOOTER_LINKS_CAT
    1: from vnccollab.theme.browser.interfaces import IVNCCollabHtmlHead
    1: from vnccollab.theme.portlets import world_clock
    1: from vnccollab.theme.settings import IWorldClockSettings
    1: from vnccollab.theme.util import getZimbraLiveAnnotatedTasks
       
    1: from plone.app.layout.links.viewlets import FaviconViewlet
       
       
    1: _pl = MessageFactory('plonelocales')
    1: logger = logging.getLogger('vnccollab.theme.RelatedRedmineTicketsViewlet')
       
       
    2: class TopRatedViewlet(common.ViewletBase):
           """Renders list of most rated items under given container.
       
           Rating system by cioppino.twothumbs.
    1:     """
       
    1:     def update(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         catalog = getToolByName(self.context, 'portal_catalog')</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         elems = []</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         for brain in catalog(path={'depth': 20,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             'query': '/'.join(self.context.getPhysicalPath())},</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             sort_on='avg_ratings',</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             sort_order='reverse'):</div>       
                   # skip item if nobody voted yet
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             if brain.positive_ratings == 0 and brain.total_down_ratings == 0:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 continue</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             elems.append({</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 'title': _(safe_unicode(brain.Title)),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 'desc': _(safe_unicode(brain.Description)),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 'url': brain.getURL(),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 'type': normalizeString(brain.portal_type, encoding='utf-8'),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 'rating': {'total': brain.avg_ratings,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                            'liked': brain.positive_ratings,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                            'disliked': brain.total_down_ratings}})</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         self.elems = tuple(elems)</div>       
       
    2: class ActionsListViewlet(common.ViewletBase):
           """Renders internal ActionsItem List object view.
       
           Gets first found ActionsItem List object in first level hierarchy.
    1:     """
       
    1:     def update(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         self.todo = None</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         for obj in self.context.objectValues():</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             if getattr(obj, 'portal_type', '') == 'ActionItemList':</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 self.todo = obj</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 break</div>       
       
    2: class LoginViewlet(common.ViewletBase):
    1:     """Most methods are copied over from login portlet renderer"""
       
    1:     template = ViewPageTemplateFile('templates/login.pt')
    1:     anon_template = ViewPageTemplateFile('templates/anon_login.pt')
       
    1:     def __init__(self, *args, **kw):
   88:         super(LoginViewlet, self).__init__(*args, **kw)
       
   88:         self.membership = getToolByName(self.context, 'portal_membership')
   88:         self.context_state = getMultiAdapter((self.context, self.request),
   88:             name=u'plone_context_state')
   88:         self.portal_state = getMultiAdapter((self.context, self.request),
   88:             name=u'plone_portal_state')
   88:         self.pas_info = getMultiAdapter((self.context, self.request),
   88:             name=u'pas_info')
       
    1:     def render(self):
   88:         mt = getToolByName(self.context, 'portal_membership')
   88:         if mt.isAnonymousUser():
   35:             return self.anon_template()
               else:
   53:             return self.template()
       
    1:     def show(self):
   53:         if not self.portal_state.anonymous():
   53:             return False
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if not self.pas_info.hasLoginPasswordExtractor():</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return False</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return True</div>               # page = self.request.get('URL', '').split('/')[-1]
               # return page not in ('login_form', '@@register')
       
    1:     @property
           def available(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return self.auth() is not None and self.show()</div>       
    1:     def signup_link(self):
   35:         return '%s/register' % self.portal_state.portal_url()
       
    1:     def help_link(self):
   35:         registry = getUtility(IRegistry)
   35:         return registry.get(
   35:             'vnccollab.theme.settings.IAnonymousHomepageSettings.help_url')
       
    1:     def login_form(self):
   35:         return '%s/login_form' % self.portal_state.portal_url()
       
    1:     def mail_password_form(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return '%s/mail_password_form' % self.portal_state.portal_url()</div>       
    1:     def login_name(self):
   53:         auth = self.auth()
   53:         name = None
   53:         if auth is not None:
   53:             name = getattr(auth, 'name_cookie', None)
   53:         if not name:
   53:             name = '__ac_name'
   53:         return name
       
    1:     def login_password(self):
   53:         auth = self.auth()
   53:         passwd = None
   53:         if auth is not None:
   53:             passwd = getattr(auth, 'pw_cookie', None)
   53:         if not passwd:
   53:             passwd = '__ac_password'
   53:         return passwd
       
    1:     def join_action(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         context = self.context</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         tool = getToolByName(context, 'portal_actions')</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         join = tool.listActionInfos(action_chain='user/join', object=context)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if len(join) &gt; 0:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return join[0]['url']</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return None</div>       
    1:     def can_register(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if getToolByName(self.context, 'portal_registration', None) is None:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return False</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return self.membership.checkPermission('Add portal member',</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             self.context)</div>       
    1:     def can_request_password(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return self.membership.checkPermission('Mail forgotten password',</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             self.context)</div>       
    1:     @memoize
    1:     def auth(self, _marker=[]):
   53:         acl_users = getToolByName(self.context, 'acl_users')
   53:         return getattr(acl_users, 'credentials_cookie_auth', None)
       
       
    2: class HeaderTimeViewlet(common.ViewletBase):
    1:     """Returns current date and time in local format"""
       
    1:     def update(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         super(HeaderTimeViewlet, self).update()</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         date = DateTime()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         self.day = date.day()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         self.month = _pl(monthname_msgid(int(date.strftime('%m'))),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             default=safe_unicode(date.Month()))</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         self.dayname = _pl(weekdayname_msgid(int(date.strftime('%w'))),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             default=safe_unicode(date.DayOfWeek()))</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         self.datetime = self.toLocalizedTime(date, long_format=True)</div>       
    1:     def toLocalizedTime(self, time, long_format=None, time_only=None):
               """Convert time to localized time
               """
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         util = getToolByName(self.context, 'translation_service')</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return util.ulocalized_time(time, long_format, time_only, self.context,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                                     domain='plonelocales')</div>       
       
    2: class PathBarViewlet(common.PathBarViewlet):
    1:     template = ViewPageTemplateFile('templates/path_bar.pt')
       
    1:     def render(self):
   88:         mt = getToolByName(self.context, 'portal_membership')
   88:         if mt.isAnonymousUser():
   35:             return u''
               else:
   53:             return self.template()
       
    2: class FooterViewlet(common.FooterViewlet):
    1:     index = ViewPageTemplateFile('templates/footer.pt')
       
    1:     def update(self):
   88:         super(FooterViewlet, self).update()
   88:         self.columns = columns = {}
       
   88:         context = aq_inner(self.context)
   88:         actions_tool = getToolByName(context, 'portal_actions')
       
               # check if we got root category for all column links
   88:         if not FOOTER_LINKS_CAT in actions_tool.objectIds():
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return</div>       
               # prepare expression context for evaluating TAL expressions
   88:         ec = actions_tool._getExprContext(context)
       
               # go over root category and collect all sub-categories
   88:         container = actions_tool[FOOTER_LINKS_CAT]
   88:         cat_ids = container.objectIds()
  352:         for cid in ('column1', 'column2', 'column3'):
                   # skip not existing categories
  264:             if cid not in cat_ids:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 continue</div>       
  264:             cat = container[cid]
  264:             if not IActionCategory.providedBy(cat):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 continue</div>       
                   # prepare category actions
  264:             actions = []
  792:             for action in cat.objectValues():
                       # look only for actions
  528:                 if not IAction.providedBy(action):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     continue</div>       
                       # create actioninfo object to compile and render TAL expressions
                       # and check if action is available in current circumstances
  528:                 info = ActionInfo(action, ec)
  528:                 if not (info['visible'] and info['allowed'] and
  470:                         info['available']):
   93:                     continue
       
                       # and finally extract all required details from action
  435:                 desc = action.getProperty('description', None) or None
  435:                 if desc is not None:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     desc = _(safe_unicode(desc))</div>  435:                 actions.append({
  435:                     'id': info['id'],
  435:                     'title': _(safe_unicode(info['title'])),
  435:                     'desc': desc,
  435:                     'url': info['url']
                       })
       
                   # finally add category to be rendered as footer column
  264:             columns[cid] = {
  264:                 'title': _(safe_unicode(cat.getProperty('title', ''))),
  264:                 'actions': tuple(actions)
                   }
       
   88:         self.columns = columns
       
       
    2: class PersonalBarViewlet(common.PersonalBarViewlet):
    1:     index = ViewPageTemplateFile('templates/personal_bar.pt')
       
    1:     def update(self):
   88:         super(PersonalBarViewlet, self).update()
       
               # get personal user image
   88:         self.user_image = None
   88:         if not self.anonymous:
   53:             mtool = getToolByName(self.context, 'portal_membership')
                   # if no userid passes it'll return portrait of logged in user
   53:             portrait = mtool.getPersonalPortrait()
   53:             if portrait is not None:
   53:                 self.user_image = portrait.absolute_url()
       
               # render languages viewlet
   88:         context = aq_inner(self.context)
   88:         languages = u''
   88:         manager = BaseOrderedViewletManager()
   88:         alsoProvides(manager, IPortalHeader)
   88:         viewlet = queryMultiAdapter((context, self.request, self.view,
   88:             manager), IViewlet, name='vnccollab.theme.languageselector')
   88:         if viewlet is not None:
   88:             viewlet = viewlet.__of__(context)
   88:             viewlet.update()
   88:             languages = viewlet.render()
   88:         self.languages = languages
       
               # Get css style for image avatar
   88:         self.avatar_width = 80
   88:         self.avatar_height = 80
   88:         self.avatar_style = ''
       
   88:         if self.user_image is not None:
   53:             img_name = os.path.basename(self.user_image)
   53:             if img_name != 'defaultUser.png':
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 img = context.portal_memberdata.portraits[img_name]</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 avatar = getUtility(IAvatarUtil)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 self.avatar_width, self.avatar_height, self.avatar_style = avatar.style(img, (80, 80))</div>       
       
    2: class VNCCarouselViewlet(CarouselViewlet):
    1:     """Customize template to fix javascript code"""
       
    1:     index = ViewPageTemplateFile('templates/carousel_viewlet.pt')
       
    2: class AnonHomepageCarouselViewlet(CarouselViewlet):
    1:     template = ViewPageTemplateFile('templates/carousel_viewlet.pt')
       
    1:     def render(self):
    1:         mt = getToolByName(self.context, 'portal_membership')
    1:         if mt.isAnonymousUser():
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return self.template()</div>               else:
    1:             return u''
       
    2: class VNCCollabHeaderViewlet(common.ViewletBase):
    1:     """Viewlet that inserts vnc header manager into plone header manager"""
       
    1:     def available(self):
               """Available only if carousel is set on current folder"""
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         context = aq_inner(self.context)</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         manager = BaseOrderedViewletManager()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         alsoProvides(manager, IVNCCollabHtmlHead)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         viewlet = queryMultiAdapter((context, self.request, self.view, manager),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             IViewlet, name='vnccollab.theme.headercarousel')</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         if viewlet is None:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return False</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         viewlet = viewlet.__of__(context)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         viewlet.update()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return viewlet.available</div>       
       
    2: class RelatedRedmineTicketsViewlet(common.ViewletBase):
    1:     """Lists redmine tickets assigned to current object"""
       
    1:     def update(self):
    5:         self.tickets = ()
       
    5:         if IPloneSiteRoot in providedBy(self.context):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return</div>       
    5:         tickets = []
               # check if settings are configured
               # check user redmine credentials and redmine url/field id
    5:         registry = getUtility(IRegistry)
    5:         url = registry.get('vnccollab.theme.redmine.url')
    5:         field_id = registry.get('vnccollab.theme.redmine.plone_uid_field_id')
    5:         username, password = self.getAuthCredentials()
    5:         if username and password and url and field_id:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             Issue = type("Issue", (ActiveResource,), {'_site': url, '_user':</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 username, '_password': password})</div>                   # do actual calls to redmine
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             try:</div>                       # fetch opened issues belonging to authenticated user
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 uuid = self.context.UID()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 data = Issue.find(**{'cf_%d' % field_id: uuid,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     'status_id': 'o', 'sort': 'updated_on:desc'})</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             except Exception:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 logException(_(u"Error during fetching redmine tickets %s" %</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     url), context=self.context, logger=logger)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 return</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             for item in data:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 info = item.to_dict()</div>       
                       # skip invalid entries
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 if not info.get('id') or not info.get('subject'):</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     continue</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 tickets.append({</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     'id': info['id'],</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     'title': safe_unicode(info['subject']),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     'body': safe_unicode(info.get('description', '')),</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                     'url': '%s/issues/%s' % (url, info['id'])</div>                       })
       
    5:         self.tickets = tuple(tickets)
       
    1:     @memoize
           def getAuthCredentials(self):
               """Returns username and password for redmine user."""
               # take username and password from authenticated user Zimbra creds
    5:         mtool = getToolByName(self.context, 'portal_membership')
    5:         member = mtool.getAuthenticatedMember()
    5:         username, password = member.getProperty('redmine_username', ''), \
    5:             member.getProperty('redmine_password', '')
               # password could contain non-ascii chars, ensure it's properly encoded
    5:         return username, safe_unicode(password).encode('utf-8')
       
       
    2: class RelatedZimbraTasksViewlet(common.ViewletBase):
    1:     """Lists zimbra tasks assigned to current object"""
       
    1:     def update(self):
    5:         self.tasks = getZimbraLiveAnnotatedTasks(self.context)
       
       
    2: class WorldClockViewlet(common.ViewletBase):
           """Shows world clock.
       
           It basically re-uses World Clock portlet code.
    1:     """
       
    1:     def update(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         context = aq_inner(self.context)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         portal = getToolByName(context, 'portal_url').getPortalObject()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         manager = getUtility(IPortletManager, name='plone.rightcolumn',</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             context=portal)</div>       
               # get settings from registry
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         registry = getUtility(IRegistry)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         try:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             settings = registry.forInterface(IWorldClockSettings)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         except KeyError:</div>                   # in case settings are not there yet
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             self.world_clock = ''</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         tz_1 = settings.tz_1</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         skin_1 = settings.skin_1</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         radius_1 = settings.radius_1</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         no_seconds_1 = settings.no_seconds_1</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         tz_2 = settings.tz_2</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         skin_2 = settings.skin_2</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         radius_2 = settings.radius_2</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         no_seconds_2 = settings.no_seconds_2</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         tz_3 = settings.tz_3</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         skin_3 = settings.skin_3</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         radius_3 = settings.radius_3</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         no_seconds_3 = settings.no_seconds_3</div>       
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         assignment = world_clock.Assignment(header=u'', tz_1=tz_1,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             skin_1=skin_1, radius_1=radius_1, no_seconds_1=no_seconds_1,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             tz_2=tz_2, skin_2=skin_2, radius_2=radius_2,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             no_seconds_2=no_seconds_2, tz_3=tz_3, skin_3=skin_3,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             radius_3=radius_3, no_seconds_3=no_seconds_3)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         renderer = queryMultiAdapter((context, self.request, self.view, manager,</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             assignment), IPortletRenderer)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         renderer.update()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         self.world_clock = renderer.render()</div>       
       
    2: class IExternalEditable(Interface):
    1:     """Marker Interface for objects than can be edited by zopeedit."""
       
       
    2: class ZopeEditViewlet(common.ViewletBase):
    1:     """Link for external editor"""
    1:     def external_editor_url(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         path = self.context.absolute_url_path()</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         p = os.path.dirname(path)</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         me = os.path.basename(path) + '.zem'</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return os.path.join(p, 'externalEdit_', me)</div>       
       
    2: class AddContentAreaViewlet(common.ViewletBase):
    1:     """Add new content form"""
    1:     index = ViewPageTemplateFile('templates/add_content_area.pt')
       
    1:     def getAddLinks(self):
               """Returns list with info of the allowed types to create using
               the add wizard.
               """
   54:         result = self._get_default_allowed_types()
  287:         ids = [x['id'] for x in result]
       
               # Adds allowed types in current context
   54:         context = aq_inner(self.context)
   54:         extend = self._allowed_types(context)
       
  126:         for item in extend:
   72:             if item['id'] not in ids:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;                 result.append(item)</div>       
   54:         return result
       
    1:     def _get_default_allowed_types(self):
               '''Default allowed types: the ones you can add to your
               member folder.'''
   54:         member_folder = self._get_member_home()
   54:         if member_folder is None:
   23:             return []
               else:
   31:             return self._allowed_types(member_folder)
       
    1:     def _get_member_home(self):
               '''Returns the cuerrent user's folder.'''
   54:         mtool = getToolByName(self.context, 'portal_membership')
   54:         member = mtool.getAuthenticatedMember()
   54:         if member is None:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return None</div>       
   54:         portal = getToolByName(self.context, 'portal_url').getPortalObject()
   54:         try:
   54:             id = member.id.replace('@', '-40')
   54:             home = portal['Members'][id]
   23:         except:
   23:             home = None
       
   54:         return home
       
    1:     def _allowed_types(self, context):
               '''Return info of the types that can be added to the context.'''
   85:         submenu = FactoriesSubMenuItem(context, self.request)
   85:         folder = self.getFolder(context)
   85:         folder_url = folder.absolute_url()
       
   85:         idnormalizer = getUtility(IIDNormalizer)
   85:         result = []
       
  390:         for atype in submenu._addableTypesInContext(folder):
  305:             id = atype.getId()
  305:             result.append({
  305:                 'id': id,
  305:                 'title': atype.Title(),
  305:                 'desc': atype.Description(),
  305:                 'url': '%s/createObject?type_name=%s' % (folder_url,
  305:                     quote_plus(id)),
  305:                 'icon': '%s/add_content_area/metabox_icon_%s.png' % (
  305:                     self.site_url, idnormalizer.normalize(id))
                   })
       
   85:         return result
       
    1:     def getUploadUrl(self):
               """
               return upload url
               in current folder
               """
   54:         context = aq_inner(self.context)
   54:         ploneview = context.restrictedTraverse('@@plone')
   54:         folder_url = ploneview.getCurrentFolderUrl()
   54:         return '%s/@@wizard_uploader' % folder_url
       
    1:     def upload_javascript(self):
   54:         return JAVASCRIPT.replace('.QuickUploadPortlet', '#createWizard')
       
    1:     @memoize
           def getFolder(self, context):
   85:         context = aq_inner(context)
   85:         submenu = FactoriesSubMenuItem(context, self.request)
   85:         if submenu.context_state.is_default_page():
    3:             return parent(context)
   82:         return submenu._addContext()
       
       
    2: class AddButtonViewlet(common.ViewletBase):
    1:     '''Overrides SearchBoxViewlet for folders in Stream Mode.'''
    1:     template = ViewPageTemplateFile('templates/addbutton.pt')
       
    1:     def render(self):
   88:         mt = getToolByName(self.context, 'portal_membership')
   88:         if mt.isAnonymousUser():
   35:             return u''
               else:
   53:             return self.template()
       
    1: try:
    1:     import vnccollab.cloudcast
    1:     from vnccollab.cloudcast.interfaces import ICastContainer, \
               ICastsContainer, ICast
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt; except ImportError:</div><div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;     CAST_ENABLED = False</div>       else:
    1:     CAST_ENABLED = True
       
       
    2: class CastViewletBase(object):
       
    1:     def get_cast_url(self):
   55:         if not CAST_ENABLED:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return False</div>       
   55:         catalog = getToolByName(self.context, 'portal_catalog')
   55:         portal_path = getToolByName(self.context, 'portal_url').getPortalPath()
   55:         casts = catalog(portal_type='CastsContainer', path={'query':
   55:             portal_path, 'depth': 1}, sort_on='getObjPositionInParent')
   55:         if len(casts) &gt; 0:
    2:             return casts[0].getURL()
       
               # no casts container in site root, search for any other casts container
   53:         casts = catalog(portal_type='CastsContainer',
   53:             sort_on='getObjPositionInParent')
   53:         if len(casts) &gt; 0:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return casts[0].getURL()</div>       
   53:         return False
       
    1:     def check_in_cast(self):
   57:         if not CAST_ENABLED:
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;             return False</div>       
   57:         cast_interfaces = [ICastsContainer, ICastContainer, ICast]
       
  222:         for cast in cast_interfaces:
  167:             if cast.providedBy(self.context):
    2:                 return True
       
   55:         return False
       
       
       # class CustomXMPPViewlet(XMPPViewlet, CastViewletBase):
       # 
       #     index = ViewPageTemplateFile('templates/xmpp_viewlet.pt')
       # 
       #     def update(self):
       #         super(CustomXMPPViewlet, self).update()
       # 
       #         # prepare link to first cast container on the site, of course if cast
       #         # feature is enabled
       #         self.cast_url = self.get_cast_url()
       #         self.cast_url = self.cast_url if self.cast_url else ''
       
       
    2: class HeaderLinksIconsViewlet(FaviconViewlet):
       
    1:     render = ViewPageTemplateFile('templates/favicon.pt')
       
       
    2: class TabsViewlet(common.ViewletBase, CastViewletBase):
       
    1:     index = ViewPageTemplateFile('templates/tabs.pt')
       
    1:     @property
           def available(self):
   90:         mt = getToolByName(self.context, 'portal_membership')
   90:         if mt.isAnonymousUser():
   35:             return False
               else:
   55:             return True
       
       
    1:     def update(self):
   90:         self.portal_tabs = []
   90:         if not self.available:
   35:             return
       
               self.portal_tabs = [
   55:             {'name': 'Content',
   55:              'description': 'content',
   55:              'id': 'content',
   55:              'url': getSite().absolute_url(),
   55:              'selected': not self.check_in_cast()
                   }]
       
   55:         cast_url = self.get_cast_url()
   55:         if cast_url != False:
    2:             self.portal_tabs.append({
    2:                 'name': 'Cast',
    2:                 'description': 'cast',
    2:                 'id': 'cast',
    2:                 'url': cast_url,
    2:                 'selected': self.check_in_cast()})
       
       
    2: class SearchBoxViewlet(common.ViewletBase):
    1:     """Overrides SearchBoxViewlet for folders in Stream Mode."""
    1:     template = ViewPageTemplateFile('templates/searchbox.pt')
       
    1:     def render(self):
   88:         mt = getToolByName(self.context, 'portal_membership')
   88:         if mt.isAnonymousUser():
   35:             return u''
               else:
   53:             return self.template()
       
    2: class EmptyViewlet(common.ViewletBase):
    1:     """Empty viewlet to remove previous registrations"""
       
    1:     def update(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         pass</div>       
    1:     def render(self):
<div class="notcovered">&gt;&gt;&gt;&gt;&gt;&gt;         return u''</div></pre>

      <div class="footer">
      Generated for revision Niewersjonowany katalog on 2013-11-13 18:40:10.922885Z
      </div>
    </body>
    </html>
